#!/bin/bash
# All-in-one launcher for File Organizer Web
# Just run: ./launch

set -e  # Exit on error

echo "=========================================="
echo "ğŸš€ File Organizer Web Launcher"
echo "=========================================="
echo ""

# Check if we're in the right directory
if [ ! -f "launch" ]; then
    echo "Error: Please run this script from the file-organizer-web directory"
    exit 1
fi

# Check if setup has been run
if [ ! -f "backend/venv/bin/activate" ]; then
    echo "âŒ Setup required!"
    echo ""
    echo "First time setup needed. This will:"
    echo "  1. Install python3-venv (requires sudo)"
    echo "  2. Create virtual environment"
    echo "  3. Install all dependencies"
    echo ""
    read -p "Run setup now? (y/n) " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        ./setup.sh
        echo ""
        
        # Verify setup succeeded
        if [ ! -f "backend/venv/bin/activate" ]; then
            echo "âŒ Setup failed!"
            echo ""
            echo "Please run './setup.sh' manually to see the error."
            echo "You may need to install python3-venv first:"
            echo "  sudo apt install python3.12-venv"
            exit 1
        fi
        
        echo "âœ… Setup complete! Now starting servers..."
        echo ""
    else
        echo ""
        echo "Setup cancelled. Please run './setup.sh' manually first."
        exit 0
    fi
fi

# Function to cleanup on exit
cleanup() {
    echo ""
    echo "=========================================="
    echo "ğŸ›‘ Shutting down File Organizer..."
    echo "=========================================="
    
    # Kill background processes
    if [ ! -z "$BACKEND_PID" ]; then
        echo "Stopping backend (PID: $BACKEND_PID)..."
        kill $BACKEND_PID 2>/dev/null || true
    fi
    
    if [ ! -z "$FRONTEND_PID" ]; then
        echo "Stopping frontend (PID: $FRONTEND_PID)..."
        kill $FRONTEND_PID 2>/dev/null || true
    fi
    
    echo ""
    echo "âœ… Stopped successfully. Goodbye!"
    exit 0
}

# Trap Ctrl+C and call cleanup
trap cleanup INT TERM

echo "Step 1/4: Starting backend server..."
cd backend
if [ ! -f "venv/bin/activate" ]; then
    echo "âŒ Error: venv/bin/activate not found"
    exit 1
fi
source venv/bin/activate
python main.py > ../logs/backend.log 2>&1 &
BACKEND_PID=$!
cd ..
echo "  âœ“ Backend started (PID: $BACKEND_PID)"
echo "  ğŸ“ Backend logs: logs/backend.log"
echo ""

# Wait for backend to be ready
echo "Step 2/4: Waiting for backend to be ready..."
for i in {1..30}; do
    if curl -s http://localhost:8000/health > /dev/null 2>&1; then
        echo "  âœ“ Backend is ready!"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "  âŒ Backend failed to start. Check logs/backend.log"
        cleanup
    fi
    sleep 1
done
echo ""

echo "Step 3/4: Starting frontend server..."
cd frontend
python3 -m http.server 8080 > ../logs/frontend.log 2>&1 &
FRONTEND_PID=$!
cd ..
sleep 2
echo "  âœ“ Frontend started (PID: $FRONTEND_PID)"
echo "  ğŸ“ Frontend logs: logs/frontend.log"
echo ""

echo "Step 4/4: Opening browser..."
# Detect browser and open
if command -v xdg-open > /dev/null; then
    xdg-open http://localhost:8080 2>/dev/null &
    echo "  âœ“ Browser opened"
elif command -v gnome-open > /dev/null; then
    gnome-open http://localhost:8080 2>/dev/null &
    echo "  âœ“ Browser opened"
elif command -v open > /dev/null; then
    open http://localhost:8080 2>/dev/null &
    echo "  âœ“ Browser opened"
else
    echo "  âš ï¸  Could not detect browser"
    echo "  ğŸ“± Open manually: http://localhost:8080"
fi
echo ""

echo "=========================================="
echo "âœ… File Organizer is Running!"
echo "=========================================="
echo ""
echo "ğŸŒ Web Interface:  http://localhost:8080"
echo "ğŸ“š API Docs:       http://localhost:8000/docs"
echo ""
echo "ğŸ“ Logs are being saved to:"
echo "   â€¢ logs/backend.log"
echo "   â€¢ logs/frontend.log"
echo ""
echo "ğŸ’¡ To view logs in real-time:"
echo "   tail -f logs/backend.log"
echo "   tail -f logs/frontend.log"
echo ""
echo "ğŸ›‘ Press Ctrl+C to stop all servers"
echo "=========================================="
echo ""

# Keep script running and wait for Ctrl+C
wait
